# Dorce.ai Backend Deployment Guide

## ðŸš€ Render Deployment Configuration

### Environment Variables Required

#### Required Variables (Set in Render Dashboard)
- `DATABASE_URL` - PostgreSQL connection string (from Render database)
- `JWT_ACCESS_SECRET` - Auto-generated by Render
- `JWT_REFRESH_SECRET` - Auto-generated by Render
- `NODE_ENV` - Set to "production"
- `PORT` - Set to "4000"

#### Optional Variables (Configure as needed)
- `REDIS_URL` - Redis connection string (from Render Redis service)
- `OPENAI_API_KEY` - For AI functionality
- `PAYSTACK_SECRET_KEY` - For payment processing
- `FRONTEND_URL` - Set to "https://dorce.ai"

### Build Configuration

#### Render.yaml Settings
```yaml
buildCommand: "chmod +x ./render-build-fix.sh && ./render-build-fix.sh"
startCommand: "node render-deploy-check.js && pnpm run start"
healthCheckPath: "/health"
```

#### Build Script (render-build-fix.sh)
The build script handles Puppeteer installation issues:
- Installs dependencies with `--ignore-scripts` to avoid Puppeteer postinstall issues
- Builds the application successfully
- Puppeteer functionality is disabled in production for stability

### Deployment Steps

1. **Database Setup**
   - Create PostgreSQL database in Render
   - Name it "dorce-postgres"
   - Wait for database to be ready

2. **Redis Setup** (Optional but recommended)
   - Create Redis service in Render
   - Name it "dorce-redis"
   - Wait for service to be ready

3. **Backend Service Setup**
   - Connect GitHub repository
   - Use the render.yaml configuration
   - Set environment variables in Render dashboard
   - Deploy and monitor logs

4. **Health Check**
   - The service exposes `/health` endpoint
   - Returns: `{ status: 'ok', timestamp: '...', uptime: ... }`
   - Render will use this to monitor service health

### Troubleshooting

#### Common Issues

1. **Build Failures**
   - Check render-build-fix.sh permissions
   - Ensure pnpm is available
   - Check Node.js version compatibility

2. **Database Connection Issues**
   - Verify DATABASE_URL is correctly set
   - Check database is running and accessible
   - Review connection string format

3. **Redis Connection Issues**
   - Verify REDIS_URL is correctly set
   - Check Redis service is running
   - Consider Redis optional for basic functionality

4. **Port Issues**
   - Ensure PORT is set to 4000 (or update main.ts)
   - Check no other services are using the same port
   - Verify health check path is accessible

5. **Environment Variable Issues**
   - Run `node render-deploy-check.js` locally to verify
   - Check all required variables are set
   - Verify secret generation worked correctly

#### Performance Optimization

1. **Database**
   - Enable connection pooling
   - Optimize queries and indexes
   - Monitor query performance

2. **Caching**
   - Implement Redis caching where appropriate
   - Use Bull queue for background jobs
   - Monitor cache hit rates

3. **Scaling**
   - Configure auto-scaling in Render
   - Monitor resource usage
   - Optimize memory usage

### Security Considerations

1. **Secrets Management**
   - Use Render's secret generation for JWT keys
   - Never commit secrets to repository
   - Rotate secrets regularly

2. **Database Security**
   - Use strong database passwords
   - Enable SSL connections
   - Limit database access

3. **API Security**
   - Implement rate limiting
   - Use CORS properly configured
   - Validate all inputs

### Monitoring

1. **Health Checks**
   - Monitor `/health` endpoint
   - Set up alerts for service downtime
   - Track response times

2. **Logs**
   - Review application logs regularly
   - Set up log aggregation if needed
   - Monitor error rates

3. **Performance Metrics**
   - Track API response times
   - Monitor database query performance
   - Watch memory and CPU usage

## ðŸŽ¯ Success Criteria

âœ… Backend builds successfully without errors
âœ… All environment variables are properly configured
âœ… Database connection is established
âœ… Health check endpoint responds correctly
âœ… Service starts and runs without crashes
âœ… API documentation is accessible at `/api/docs`

## ðŸ“ž Support

If deployment issues persist:
1. Check Render service logs
2. Verify environment variable configuration
3. Test locally with similar configuration
4. Review this deployment guide
5. Consider using the production Dockerfile (Dockerfile.production)